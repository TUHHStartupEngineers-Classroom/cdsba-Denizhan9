{
  "hash": "92f2e0ac358f0855a6011a3e7a9a926c",
  "result": {
    "markdown": "---\ntitle: \"Matching and Subclassification\"\n---\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-1_306c489035eacab4ba8795260ffae816'}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(dagitty)\nlibrary(ggdag)\ndf <- readRDS((\"data/membership.rds\"))\n\ndag_model <- 'dag {\nbb=\"0,0,1,1\"\nage [pos=\"0.2,0.2\"]\nsex [pos=\"0.3,0.2\"]\ncard [exposure,pos=\"0.3,0.6\"]\navg_pur [outcome,pos=\"0.4,0.4\"]\npre_avg_pur [pos=\"0.2,0.6\"]\ncard -> avg_pur\npre_avg_pur -> Avg_purch\npre_avg_pur -> card\nage -> card\nage -> pre_avg_pur\nsex -> card\nsex -> pre_avg_pur\n}\n'\n# draw DAG\nggdag_status(dag_model) +\n  guides(fill = \"none\", color = \"none\") +  # Disable the legend\n  geom_dag_edges(edge_color = \"black\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 1 rows containing missing values (`geom_dag_point()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 1 rows containing missing values (`geom_dag_text()`).\n```\n:::\n\n::: {.cell-output-display}\n![](07_matching_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-2_ad5ac23e7f6abb737a281b9f276f51e6'}\n\n```{.r .cell-code}\nlibrary(MatchIt)\nlibrary(dplyr)\nlibrary(Matching)\n\n\n# Load your data\ndata <- readRDS(\"data/membership.rds\")\n\n# Assignment 2: Linear Regression Model\nmodel_linear <- lm(avg_purch ~ card, data = data)\nsummary(model_linear)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = avg_purch ~ card, data = data)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-101.515  -20.684   -0.199   20.424  120.166 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  65.9397     0.3965  166.29   <2e-16 ***\ncard         25.2195     0.6095   41.38   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 30.11 on 9998 degrees of freedom\nMultiple R-squared:  0.1462,\tAdjusted R-squared:  0.1461 \nF-statistic:  1712 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\n# Assignment 3: Causal Inference Analysis\ncem_match <- matchit(card ~ pre_avg_purch + age + sex,\n                     data = data,\n                     method = 'cem',\n                     estimand = 'ATE')\ndata_cem <- match.data(cem_match)\nmodel_cem <- lm(avg_purch ~ card, data = data_cem, weights = weights)\nsummary(model_cem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = avg_purch ~ card, data = data_cem, weights = weights)\n\nWeighted Residuals:\n     Min       1Q   Median       3Q      Max \n-159.349  -20.459   -0.151   19.863  161.528 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  69.9896     0.3984  175.66   <2e-16 ***\ncard         15.2043     0.6137   24.77   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 30.12 on 9878 degrees of freedom\nMultiple R-squared:  0.0585,\tAdjusted R-squared:  0.0584 \nF-statistic: 613.7 on 1 and 9878 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nnn_match <- matchit(card ~ pre_avg_purch + age + sex,\n                    data = data,\n                    method = \"nearest\",\n                    distance = \"mahalanobis\",\n                    replace = TRUE)\ndata_nn <- match.data(nn_match)\nmodel_nn <- lm(pre_avg_purch ~ card, data = data_nn, weights = weights)\nsummary(model_nn)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = pre_avg_purch ~ card, data = data_nn, weights = weights)\n\nWeighted Residuals:\n    Min      1Q  Median      3Q     Max \n-85.464 -19.097  -1.866  16.325 124.497 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  76.2937     0.5065 150.616   <2e-16 ***\ncard          0.1001     0.6472   0.155    0.877    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 26.21 on 6907 degrees of freedom\nMultiple R-squared:  3.462e-06,\tAdjusted R-squared:  -0.0001413 \nF-statistic: 0.02391 on 1 and 6907 DF,  p-value: 0.8771\n```\n:::\n\n```{.r .cell-code}\npropensity_model <- glm(card ~ pre_avg_purch + age + sex,\n                        data = data,\n                        family = binomial(link = \"logit\"))\ndata_augmented <- data %>% mutate(propensity_score = predict(propensity_model, type = \"response\"))\n\n\ndata_ipw <- data_augmented %>% mutate(\n  ipw_score = (card / propensity_score) + ((1 - card) / (1 - propensity_score))\n)\n\nmodel_ipw <- lm(avg_purch ~ card, data = data_ipw, weights = ipw_score)\nsummary(model_ipw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = avg_purch ~ card, data = data_ipw, weights = ipw_score)\n\nWeighted Residuals:\n     Min       1Q   Median       3Q      Max \n-205.353  -28.995   -0.275   28.787  214.307 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  70.2628     0.4320  162.66   <2e-16 ***\ncard         14.9573     0.6109   24.48   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 43.19 on 9998 degrees of freedom\nMultiple R-squared:  0.05657,\tAdjusted R-squared:  0.05647 \nF-statistic: 599.5 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nmodel_ipw_trim <- lm(avg_purch ~ card,\n                     data = data_ipw %>% filter(propensity_score %>% between(0.15, 0.85)),\n                     weights = ipw_score)\nsummary(model_ipw_trim)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = avg_purch ~ card, data = data_ipw %>% filter(propensity_score %>% \n    between(0.15, 0.85)), weights = ipw_score)\n\nWeighted Residuals:\n     Min       1Q   Median       3Q      Max \n-205.353  -28.995   -0.275   28.787  214.307 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  70.2628     0.4320  162.66   <2e-16 ***\ncard         14.9573     0.6109   24.48   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 43.19 on 9998 degrees of freedom\nMultiple R-squared:  0.05657,\tAdjusted R-squared:  0.05647 \nF-statistic: 599.5 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nmodel_summary <- modelsummary::modelsummary(list(\"Naive\" = model_linear,\n                                                 \"CEM\" = model_cem,\n                                                 \"NN\" = model_nn,\n                                                 \"IPW1\" = model_ipw,\n                                                 \"IPW2\" = model_ipw_trim))\nmodel_summary\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\"> Naive </th>\n   <th style=\"text-align:center;\"> CEM </th>\n   <th style=\"text-align:center;\"> NN </th>\n   <th style=\"text-align:center;\">  IPW1 </th>\n   <th style=\"text-align:center;\">  IPW2 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:center;\"> 65.940 </td>\n   <td style=\"text-align:center;\"> 69.990 </td>\n   <td style=\"text-align:center;\"> 76.294 </td>\n   <td style=\"text-align:center;\"> 70.263 </td>\n   <td style=\"text-align:center;\"> 70.263 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:center;\"> (0.397) </td>\n   <td style=\"text-align:center;\"> (0.398) </td>\n   <td style=\"text-align:center;\"> (0.507) </td>\n   <td style=\"text-align:center;\"> (0.432) </td>\n   <td style=\"text-align:center;\"> (0.432) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> card </td>\n   <td style=\"text-align:center;\"> 25.220 </td>\n   <td style=\"text-align:center;\"> 15.204 </td>\n   <td style=\"text-align:center;\"> 0.100 </td>\n   <td style=\"text-align:center;\"> 14.957 </td>\n   <td style=\"text-align:center;\"> 14.957 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;box-shadow: 0px 1.5px\">  </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.610) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.614) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.647) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.611) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.611) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Num.Obs. </td>\n   <td style=\"text-align:center;\"> 10000 </td>\n   <td style=\"text-align:center;\"> 9880 </td>\n   <td style=\"text-align:center;\"> 6909 </td>\n   <td style=\"text-align:center;\"> 10000 </td>\n   <td style=\"text-align:center;\"> 10000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> R2 </td>\n   <td style=\"text-align:center;\"> 0.146 </td>\n   <td style=\"text-align:center;\"> 0.058 </td>\n   <td style=\"text-align:center;\"> 0.000 </td>\n   <td style=\"text-align:center;\"> 0.057 </td>\n   <td style=\"text-align:center;\"> 0.057 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> R2 Adj. </td>\n   <td style=\"text-align:center;\"> 0.146 </td>\n   <td style=\"text-align:center;\"> 0.058 </td>\n   <td style=\"text-align:center;\"> 0.000 </td>\n   <td style=\"text-align:center;\"> 0.056 </td>\n   <td style=\"text-align:center;\"> 0.056 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> AIC </td>\n   <td style=\"text-align:center;\"> 96483.2 </td>\n   <td style=\"text-align:center;\"> 95595.0 </td>\n   <td style=\"text-align:center;\"> 65071.1 </td>\n   <td style=\"text-align:center;\"> 97072.1 </td>\n   <td style=\"text-align:center;\"> 97072.1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> BIC </td>\n   <td style=\"text-align:center;\"> 96504.8 </td>\n   <td style=\"text-align:center;\"> 95616.6 </td>\n   <td style=\"text-align:center;\"> 65091.6 </td>\n   <td style=\"text-align:center;\"> 97093.7 </td>\n   <td style=\"text-align:center;\"> 97093.7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Log.Lik. </td>\n   <td style=\"text-align:center;\"> -48238.590 </td>\n   <td style=\"text-align:center;\"> -47794.497 </td>\n   <td style=\"text-align:center;\"> -32532.552 </td>\n   <td style=\"text-align:center;\"> -48533.031 </td>\n   <td style=\"text-align:center;\"> -48533.031 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> RMSE </td>\n   <td style=\"text-align:center;\"> 30.11 </td>\n   <td style=\"text-align:center;\"> 30.08 </td>\n   <td style=\"text-align:center;\"> 26.07 </td>\n   <td style=\"text-align:center;\"> 30.54 </td>\n   <td style=\"text-align:center;\"> 30.54 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\r\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}